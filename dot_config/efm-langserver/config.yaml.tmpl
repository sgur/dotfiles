---
version: 2
root-markers:
  - .git/

commands:
  - title: reload
    command: :reload-config

  - title: open (system default)
    os: windows
    command: rundll32
    arguments:
      - 'url.dll,FileProtocolHandler'
      - '${FILENAME}'
  - title: open (system default)
    os: linux
    command: xdg-open
    arguments:
      - '${FILENAME}'
  - title: open (system default)
    os: darwin
    command: open
    arguments:
      - '${FILENAME}'
{{ if eq .chezmoi.os "windows" }}
  - title: install dependencies (scoop)
    command: scoop
    arguments:
      - install
      - hadolint
      - actionlint
      - nodejs-lts
{{- else }}
  - title: install dependencies (brew)
    command: brew install hadolint actionlint node@16
{{- end }}

tools:
  css-stylelint: &css-stylelint
    prefix: stylelint
    lint-command: >-
      {{ lookPath "npx" }}
      --package=stylelint
      --package=stylelint-config-standard
      --
      stylelint
      --formatter unix
      --config
      {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/stylelintrc.yaml
      --stdin
      --stdin-filename ${INPUT}
    lint-stdin: true
    lint-formats:
      - "%f:%l:%c: %m"
    commands:
      - title: 'stylelint fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--yes'
          - '--package=stylelint'
          - '--package=stylelint-config-standard'
          - '--'
          - 'stylelint'
          - '--config'
          - '{{- if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/stylelint.config.js'
          - '--fix'
          - '${INPUT}'

  javascript-eslint: &javascript-eslint
    prefix: eslint
    lint-command: {{ lookPath "npx" }} --no-install eslint -f unix --stdin --stdin-filename ${INPUT}
    lint-ignore-exit-code: true
    lint-stdin: true
    root-markers:
      - package.json
      - .eslintrc.js
      - .eslintrc.yaml
      - .eslintrc.yml
      - .eslintrc.json
    commands:
      - title: 'eslint fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--no-install'
          - 'eslint'
          - '--fix'
          - '${INPUT}'

  any-prettier: &any-prettier
    prefix: prettier
    format-command: {{ lookPath "npx" }} --yes prettier
    root-markers:
      - .prettierrc
      - .prettierrc.json
      - .prettierrc.yml
      - .prettierrc.yaml
      - .prettierrc.json5
      - .prettierrc.js
      - .prettierrc.cjs
      - prettier.config.js
      - prettier.config.cjs
      - .prettierrc.toml
    commands:
      - title: 'prettier fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--yes'
          - 'prettier'
          - '--fix'
          - '--write'
          - '${INPUT}'

  markdown-markdownlint-cli2: &markdown-markdownlint-cli2
    prefix: markdownlint-cli2
    lint-command: >-
      {{ lookPath "npx" }}
      --yes
      --package=markdownlint-cli2
      --
      markdownlint-cli2-config
      {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/config.markdownlint-cli2.yaml
    lint-stdin: false
    lint-formats:
      - "%f:%l:%c %m"
      - "%f:%l %m"
      - "%-G%.%#"

  markdown-markdownlint: &markdown-markdownlint
    prefix: markdownlint
    lint-command: >-
      {{ lookPath "npx" }}
      --yes
      --package=markdownlint-cli
      --
      markdownlint
      --config {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/markdownlint.yaml
      --stdin
    lint-stdin: true
    lint-formats:
      - "%f:%l:%c %m"
      - "%f:%l %m"
    commands:
      - title: 'markdownlint fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--yes'
          - '--package=markdownlint-cli'
          - '--'
          - 'markdownlint'
          - '--config {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/markdownlint.yaml'
          - '--fix'
          - '${INPUT}'

  html-markuplint: &html-markuplint
    prefix: markuplint
    lint-command: {{ lookPath "npx" }} --yes markuplint --no-color --format Default
    lint-stdin: false
    lint-formats:
      - "%E<markuplint> error: %m %f:%l:%c"
      - "%C%.%#"
      - "%-G%.%#"
    commands:
      - title: 'markuplint fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--yes'
          - 'markuplint'
          - '--no-color'
          - '--fix'
          - '${INPUT}'

# pip3 install --user flake8
  python-flake8: &python-flake8
    prefix: flake8
    lint-command: "flake8 --stdin-display-name ${INPUT} -"
    lint-stdin: true
    lint-formats:
      - "%f:%l:%c: %m"

# pip3 install --user mypy
  python-mypy: &python-mypy
    prefix: mypy
    lint-command: "mypy --show-column-numbers"
    lint-formats:
      - "%f:%l:%c: %trror: %m"
      - "%f:%l:%c: %tarning: %m"
      - "%f:%l:%c: %tote: %m"

# pip3 install --user black
  python-black: &python-black
    prefix: black
    format-command: "black --quiet -"
    format-stdin: true

# {scoop,brew} install hadolint
  dockerfile-hadolint: &dockerfile-hadolint
    prefix: hadolint
    lint-command: hadolint
    lint-formats:
      - "%f:%l %m"

# pip3 install --user yamllint
  yaml-yamllint: &yaml-yamllint
    prefix: yamllint
    lint-command: "yamllint --strict --format parsable -"
    lint-stdin: true
    lint-formats:
      - '%f:%l:%c: [%t%*[a-z]] %m'
    env:
      - 'PYTHONIOENCODING=UTF-8'
      - 'PYTHONUTF8=1'

# scoop or brew install actionlint
  yaml-actionlint: &yaml-actionlint
    prefix: actionlint
    lint-command: >-
{{- if ne .chezmoi.os "windows" }}
      bash -c \"[[ '${INPUT}' =~ \\\\.github/workflows/ ]]\" &&
{{- end }}
      actionlint
      -oneline
      -no-color
      -stdin-filename
      \"${INPUT}\"
      -
    lint-stdin: true
    lint-formats:
      - '%f:%l:%c: %m'
    root-markers:
      - .github

  any-cspell: &any-cspell
    prefix: cspell
    lint-command: >-
      {{ lookPath "npx" }} --yes
      --
      cspell
      --no-progress
      --no-color
      --no-summary
      --config {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/cspell.config.yaml
    lint-stdin: false
    lint-formats:
      - "%I%f:%l:%c - %m"
      - "%Z"

  any-commitlint: &any-commitlint
    prefix: commitlint
    lint-command: >-
      {{ lookPath "npx" }} --yes
      --package=@commitlint/cli
      --
      commitlint
      --config {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/commitlintrc.yaml
    lint-stdin: true
    lint-formats:
      - "%-G✖   found%.%#"
      - "%E✖   %m"
      - "%Z%W⚠   %m"
      - "%I     %m"
      - "%Z%-G%.%#"

  any-textlint: &any-textlint
    prefix: textlint
    lint-command: >-
      {{ lookPath "npx" }} --yes
      --package=textlint
      --package=textlint-rule-preset-ja-technical-writing
      --package=textlint-rule-preset-ja-spacing
      --package=textlint-rule-preset-japanese
      --
      textlint
      --config {{ if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/textlintrc.yaml
      -f unix --no-color --stdin --stdin-filename ${INPUT}
    lint-stdin: true
    lint-formats:
      - "%f:%l:%c: %m [%trror/%r]"
      - "%f:%l:%c: 【%r】 %m"
      - "%E%f:%l:%c: %m"
      - "%Z%m [%trror/%r]"
      - "%C%m"
    commands:
      - title: 'textlint fix'
        command: {{ lookPath "npx" }}
        arguments:
          - '--yes'
          - '--package=textlint'
          - '--package=textlint-rule-preset-ja-technical-writing'
          - '--package=textlint-rule-preset-ja-spacing'
          - '--package=textlint-rule-preset-japanese'
          - 'textlint'
          - '--config'
          - '{{- if eq .chezmoi.os "windows" -}} %USERPROFILE% {{- else -}} ~ {{- end -}} /.config/textlintrc.json'
          - '--fix'
          - '${INPUT}'

languages:
  css:
    # - <<: *css-stylelint
    - <<: *any-prettier

  dockerfile:
    - <<: *dockerfile-hadolint

  html:
    - <<: *any-prettier
    - <<: *html-markuplint

  javascript:
    - <<: *javascript-eslint
    - <<: *any-prettier

  javascriptreact:
    - <<: *javascript-eslint
    - <<: *any-prettier

  json:
    - <<: *any-prettier

  text:
    - <<: *any-textlint

  markdown:
    - <<: *markdown-markdownlint-cli2
    - <<: *any-textlint
    - <<: *any-prettier

  python:
    - <<: *python-flake8
    - <<: *python-mypy
    - <<: *python-black

  scss:
    - <<: *css-stylelint
    - <<: *any-prettier

  typescript:
    - <<: *javascript-eslint
    - <<: *any-prettier

  typescriptreact:
    - <<: *javascript-eslint
    - <<: *any-prettier

  vue:
    - <<: *javascript-eslint
    - <<: *any-prettier

  yaml:
    - <<: *yaml-yamllint
    - <<: *yaml-actionlint
    - <<: *any-prettier

  gitcommit:
    - <<: *any-commitlint

  =:
    - <<: *any-cspell
