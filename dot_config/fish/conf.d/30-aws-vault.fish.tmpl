{{ if lookPath "aws-vault" -}}
{{   if get (stat (joinPath .chezmoi.homeDir ".password-store")) "isDir" -}}
set -gx AWS_VAULT_BACKEND pass
set -gx AWS_VAULT_PASS_PREFIX aws-vault

{{     if lookPath "gopass" -}}
set -gx AWS_VAULT_PASS_CMD gopass
{{     else -}}
set -gx AWS_VAULT_PASS_CMD pass
{{     end -}}
{{   else if eq .chezmoi.os "darwin" -}}
set -gx AWS_VAULT_BACKEND keychain
set -gx AWS_VAULT_PROMPT terminal
{{   end -}}

{{   if lookPath "fzf" }}
function fzf-aws-profile-widget
  set -l commandline (__fzf_parse_commandline)
    set -lx dir $commandline[1]
    set -l fzf_query $commandline[2]
    set -l prefix $commandline[3]

    test -n "$FZF_TMUX_HEIGHT"; or set FZF_TMUX_HEIGHT 40%
    begin
        set -lx FZF_DEFAULT_OPTS (__fzf_defaults "--reverse")
        set -lx FZF_DEFAULT_OPTS_FILE ''
        set -lx FZF_DEFAULT_COMMAND ""
        aws-vault list --profiles | eval (__fzfcmd) --no-multi --query=$fzf_query | read -l result

        if test -n "$result"
	    aws-vault exec $result

            # Remove last token from commandline.
            commandline -t ""
            commandline -it -- $prefix
        end
    end

    commandline -f repaint
end
{{   end -}}
{{- end }}
